services:
  z-image-mcp:
    container_name: z-image-mcp
    build:
      context: ./mcp-zimage
      dockerfile: Dockerfile
    ports:
      - "${PORT:-8000}:8000"
    volumes:
      - huggingface_cache:/root/.cache/huggingface
    environment:
      - MCP_TRANSPORT=${Z_IMAGE_MCP_TRANSPORT:-sse}
      - MINIO_ENDPOINT=http://mcp-minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET_NAME=${Z_IMAGE_MINIO_BUCKET_NAME:-zimage}

      - MINIO_EXTERNAL_ENDPOINT=${EXTERNAL_IP:-http://localhost}:${EXTERNAL_MINIO_PORT:-49000}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ "${Z_IMAGE_GPU_DEVICE_ID:-0}" ]
              capabilities: [ gpu ]
    restart: unless-stopped

volumes:
  huggingface_cache:

networks:
  default:
    name: mcp-diffusers
    external: true